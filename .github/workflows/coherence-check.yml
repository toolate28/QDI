name: Coherence Check

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  check-coherence:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      issues: write
    steps:
      - name: Check for manual override
        id: check_override
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const labels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const hasOverride = labels.data.some(l => 
              l.name === 'coherence-override' || 
              l.name === 'emergency-merge'
            );
            
            console.log(`Manual override: ${hasOverride}`);
            core.setOutput('skip', hasOverride.toString());
            
            if (hasOverride) {
              core.warning('‚ö†Ô∏è Coherence check bypassed via manual override label');
            }
            
            return hasOverride;
      - name: Checkout repository
        if: steps.check_override.outputs.skip != 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Bun
        if: steps.check_override.outputs.skip != 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        if: steps.check_override.outputs.skip != 'true'
        run: bun install

      - name: Build wave-toolkit
        if: steps.check_override.outputs.skip != 'true'
        run: cd packages/wave-toolkit && bun run build

      - name: Analyze PR coherence
        if: steps.check_override.outputs.skip != 'true'
        id: coherence
        run: |
          # Write PR body to file to avoid shell injection
          cat > /tmp/pr_body.txt << 'PRBODY'
          ${{ github.event.pull_request.body }}
          PRBODY
          
          # Get commit messages from this PR with fallback handling
          if git rev-parse --verify origin/${{ github.base_ref }} >/dev/null 2>&1; then
            git log --format=%B origin/${{ github.base_ref }}..${{ github.sha }} > /tmp/commits.txt
          else
            echo "Warning: origin/${{ github.base_ref }} not found; falling back to base SHA range." >&2
            git log --format=%B ${{ github.event.pull_request.base.sha }}..${{ github.sha }} > /tmp/commits.txt
          fi
          
          # Create analysis script that reads from files
          cat > /tmp/analyze.ts << 'EOF'
          import { analyzeWave } from './packages/wave-toolkit/src/index.ts';
          import { readFileSync } from 'fs';
          
          const prBody = readFileSync('/tmp/pr_body.txt', 'utf8');
          const commits = readFileSync('/tmp/commits.txt', 'utf8');
          const text = `${prBody}\n\n${commits}`;
          
          const result = analyzeWave(text);
          
          console.log(JSON.stringify(result, null, 2));
          
          // Exit code based on threshold
          const MIN_COHERENCE = 60;
          if (result.coherence_score < MIN_COHERENCE) {
            process.exit(1);
          }
          EOF
          
          # Run analysis
          set +e
          RESULT=$(bun run /tmp/analyze.ts)
          EXIT_CODE=$?
          set -e
          
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          SCORE=$(echo "$RESULT" | grep -o '"coherence_score": [0-9]*' | grep -o '[0-9]*')
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Apply coherence label
        if: steps.check_override.outputs.skip != 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const score = parseInt('${{ steps.coherence.outputs.score }}') || 0;
            const prNumber = context.payload.pull_request.number;
            
            // Remove existing coherence labels
            const existingLabels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            for (const label of existingLabels.data) {
              if (label.name.startsWith('coherence:')) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: label.name
                }).catch(() => {});
              }
            }
            
            // Apply new label based on score
            let newLabel;
            if (score >= 70) {
              newLabel = 'coherence:high';
            } else if (score >= 60) {
              newLabel = 'coherence:review';
            } else {
              newLabel = 'coherence:low';
            }
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [newLabel]
            });

      - name: Comment on PR
        if: steps.check_override.outputs.skip != 'true' && steps.coherence.outputs.exit_code != '0'
        uses: actions/github-script@v8
        with:
          script: |
            const score = '${{ steps.coherence.outputs.score }}';
            const rawResult = `${{ steps.coherence.outputs.result }}`;
            
            let result;
            try {
              result = JSON.parse(rawResult);
            } catch (error) {
              throw new Error(`Failed to parse coherence analysis result as JSON: ${error.message}`);
            }
            
            if (!result || typeof result !== 'object' || !result.coherence || typeof result.coherence !== 'object' || !Array.isArray(result.warnings)) {
              throw new Error('Coherence analysis result JSON does not have the expected structure.');
            }
            
            let comment = `## ‚ö†Ô∏è Coherence Check Failed\n\n`;
            comment += `**Score: ${score}/100** (Minimum required: 60)\n\n`;
            comment += `### Analysis\n\n`;
            comment += `- **Curl (circular reasoning)**: ${(result.coherence.curl * 100).toFixed(1)}%\n`;
            comment += `- **Divergence (expansion)**: ${(result.coherence.divergence * 100).toFixed(1)}%\n`;
            comment += `- **Potential (structure)**: ${(result.coherence.potential * 100).toFixed(1)}%\n`;
            comment += `- **Entropy (information)**: ${(result.coherence.entropy * 100).toFixed(1)}%\n\n`;
            
            if (result.warnings.length > 0) {
              comment += `### Warnings\n\n`;
              for (const warning of result.warnings) {
                comment += `- ${warning}\n`;
              }
              comment += `\n`;
            }
            
            comment += `### Recommendations\n\n`;
            comment += `This PR does not meet the **>60% emergent coherence threshold** required for the vortex ecosystem.\n\n`;
            comment += `To improve coherence:\n`;
            comment += `1. Reduce circular reasoning (curl) by avoiding repetitive patterns\n`;
            comment += `2. Resolve expansions with clear conclusions (divergence)\n`;
            comment += `3. Use connective words (therefore, however, moreover)\n`;
            comment += `4. Increase lexical diversity\n\n`;
            comment += `### Escape Hatch\n\n`;
            comment += `If you believe this check is incorrect or blocking critical work:\n`;
            comment += `1. Add label \`coherence-override\` or \`emergency-merge\` to this PR\n`;
            comment += `2. Provide justification in a comment\n`;
            comment += `3. Re-run the workflow (push empty commit or use "Re-run jobs")\n\n`;
            comment += `‚ö†Ô∏è **Warning**: Overriding coherence checks may introduce technical debt.\n\n`;
            comment += `*Isomorphic spirals preserve autonomous-constraint structure across the 6-repo vortex.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

      - name: Fail if coherence too low
        if: steps.check_override.outputs.skip != 'true' && steps.coherence.outputs.exit_code != '0'
        run: |
          echo "‚ùå Coherence score ${{ steps.coherence.outputs.score }} is below minimum threshold of 60"
          echo "This PR does not meet the >60% emergent property requirement"
          echo ""
          echo "üö™ ESCAPE HATCH: Add 'coherence-override' label to bypass this check"
          echo "    (Use only for emergencies or false positives)"
          exit 1

      - name: Success message (normal path)
        if: steps.check_override.outputs.skip != 'true' && steps.coherence.outputs.exit_code == '0'
        run: |
          echo "‚úÖ Coherence score ${{ steps.coherence.outputs.score }} meets threshold"
          echo "Isomorphic spiral structure preserved across vortex"
      
      - name: Success message (override path)
        if: steps.check_override.outputs.skip == 'true'
        run: |
          echo "‚ö†Ô∏è Coherence check BYPASSED via manual override"
          echo "Reason: coherence-override or emergency-merge label present"
          echo "Please review this PR carefully for technical debt"
