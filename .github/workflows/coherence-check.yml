name: Coherence Check

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  check-coherence:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build wave-toolkit
        run: cd packages/wave-toolkit && bun run build

      - name: Analyze PR coherence
        id: coherence
        run: |
          # Extract PR description and commit messages
          PR_BODY="${{ github.event.pull_request.body || '' }}"
          
          # Get commit messages from this PR
          COMMITS=$(git log --format=%B origin/${{ github.base_ref }}..${{ github.sha }})
          
          # Combine for analysis
          TEXT_TO_ANALYZE="$PR_BODY\n\n$COMMITS"
          
          # Create analysis script
          cat > /tmp/analyze.ts << 'EOF'
          import { analyzeWave } from './packages/wave-toolkit/src/index.ts';
          
          const text = process.argv[2] || '';
          const result = analyzeWave(text);
          
          console.log(JSON.stringify(result, null, 2));
          
          // Exit code based on threshold
          const MIN_COHERENCE = 60;
          if (result.coherence_score < MIN_COHERENCE) {
            process.exit(1);
          }
          EOF
          
          # Run analysis
          set +e
          RESULT=$(bun run /tmp/analyze.ts "$TEXT_TO_ANALYZE")
          EXIT_CODE=$?
          set -e
          
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          SCORE=$(echo "$RESULT" | grep -o '"coherence_score": [0-9]*' | grep -o '[0-9]*')
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Apply coherence label
        uses: actions/github-script@v7
        with:
          script: |
            const score = parseInt('${{ steps.coherence.outputs.score }}') || 0;
            const prNumber = context.payload.pull_request.number;
            
            // Remove existing coherence labels
            const existingLabels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            for (const label of existingLabels.data) {
              if (label.name.startsWith('coherence:')) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: label.name
                }).catch(() => {});
              }
            }
            
            // Apply new label based on score
            let newLabel;
            if (score >= 70) {
              newLabel = 'coherence:high';
            } else if (score >= 60) {
              newLabel = 'coherence:review';
            } else {
              newLabel = 'coherence:low';
            }
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [newLabel]
            });

      - name: Comment on PR
        if: steps.coherence.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const score = '${{ steps.coherence.outputs.score }}';
            const result = JSON.parse(`${{ steps.coherence.outputs.result }}`);
            
            let comment = `## ⚠️ Coherence Check Failed\n\n`;
            comment += `**Score: ${score}/100** (Minimum required: 60)\n\n`;
            comment += `### Analysis\n\n`;
            comment += `- **Curl (circular reasoning)**: ${(result.coherence.curl * 100).toFixed(1)}%\n`;
            comment += `- **Divergence (expansion)**: ${(result.coherence.divergence * 100).toFixed(1)}%\n`;
            comment += `- **Potential (structure)**: ${(result.coherence.potential * 100).toFixed(1)}%\n`;
            comment += `- **Entropy (information)**: ${(result.coherence.entropy * 100).toFixed(1)}%\n\n`;
            
            if (result.warnings.length > 0) {
              comment += `### Warnings\n\n`;
              for (const warning of result.warnings) {
                comment += `- ${warning}\n`;
              }
              comment += `\n`;
            }
            
            comment += `### Recommendations\n\n`;
            comment += `This PR does not meet the **>60% emergent coherence threshold** required for the vortex ecosystem.\n\n`;
            comment += `To improve coherence:\n`;
            comment += `1. Reduce circular reasoning (curl) by avoiding repetitive patterns\n`;
            comment += `2. Resolve expansions with clear conclusions (divergence)\n`;
            comment += `3. Use connective words (therefore, however, moreover)\n`;
            comment += `4. Increase lexical diversity\n\n`;
            comment += `*Isomorphic spirals preserve autonomous-constraint structure across the 6-repo vortex.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

      - name: Fail if coherence too low
        if: steps.coherence.outputs.exit_code != '0'
        run: |
          echo "❌ Coherence score ${{ steps.coherence.outputs.score }} is below minimum threshold of 60"
          echo "This PR does not meet the >60% emergent property requirement"
          exit 1

      - name: Success message
        if: steps.coherence.outputs.exit_code == '0'
        run: |
          echo "✅ Coherence score ${{ steps.coherence.outputs.score }} meets threshold"
          echo "Isomorphic spiral structure preserved across vortex"
