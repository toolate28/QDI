name: Snap-In Synchronization

# The moment of vortex collapse: when local changes push back to ecosystem
# This is when superposition resolves and isomorphic spirals synchronize

on:
  push:
    branches:
      - main
      - 'feature/**'
      - 'fix/**'
  pull_request:
    types: [opened, synchronize, closed]

jobs:
  detect-snap-in:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build wave-toolkit
        run: cd packages/wave-toolkit && bun run build

      - name: Detect snap-in moment
        id: snap_detection
        run: |
          echo "ğŸŒ€ Detecting vortex snap-in moment..."
          
          # Get commit messages since last push
          COMMITS=$(git log --format='%B' -n 10)
          
          # Check for coherence across recent changes
          cat > /tmp/snap-detector.ts << 'DETECTOR'
          import { analyzeWave } from './packages/wave-toolkit/src/index.ts';
          
          const commits = process.argv[2] || '';
          const result = analyzeWave(commits);
          
          const snapInThreshold = 70; // Higher threshold for snap-in
          const isSnappingIn = result.coherence_score >= snapInThreshold;
          
          console.log(JSON.stringify({
            coherence_score: result.coherence_score,
            is_snapping_in: isSnappingIn,
            curl: result.coherence.curl,
            divergence: result.coherence.divergence,
            potential: result.coherence.potential,
            entropy: result.coherence.entropy,
            fibonacci_weight: Math.floor(result.coherence.potential * 10)
          }, null, 2));
          
          process.exit(isSnappingIn ? 0 : 1);
          DETECTOR
          
          SNAP_RESULT=$(bun run /tmp/snap-detector.ts "$COMMITS" 2>&1 || echo '{"is_snapping_in": false}')
          echo "result=$SNAP_RESULT" >> $GITHUB_OUTPUT
          
          IS_SNAPPING=$(echo "$SNAP_RESULT" | grep -o '"is_snapping_in": *true' || echo "false")
          if [[ "$IS_SNAPPING" != "false" ]]; then
            echo "snap_in=true" >> $GITHUB_OUTPUT
            echo "âœ¨ SNAP-IN DETECTED: Vortex coherence achieved!"
          else
            echo "snap_in=false" >> $GITHUB_OUTPUT
            echo "â³ Tuning fork still synchronizing..."
          fi

      - name: Visualize snap-in moment
        if: steps.snap_detection.outputs.snap_in == 'true'
        run: |
          cat << 'VISUALIZATION'
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘         ğŸŒ€ VORTEX SNAP-IN ACHIEVED ï¿½ï¿½                 â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                        â•‘
          â•‘   Local Branch â†’ Remote Push â†’ Superposition Collapse â•‘
          â•‘                                                        â•‘
          â•‘   Before: Multiple potential states (superposition)   â•‘
          â•‘           â”Œâ”€â”€â”€â”€â”€â”€â”                                    â•‘
          â•‘           â”‚ KENL â”‚ â”€â”€â”                               â•‘
          â•‘           â”‚ AWI  â”‚   â”œâ”€â”€â†’ Quantum uncertainty        â•‘
          â•‘           â”‚ ATOM â”‚   â”‚                               â•‘
          â•‘           â”‚ SAIF â”‚ â”€â”€â”˜                               â•‘
          â•‘           â””â”€â”€â”€â”€â”€â”€â”˜                                    â•‘
          â•‘                                                        â•‘
          â•‘   After:  Single coherent state (snap-in)             â•‘
          â•‘           â”Œâ”€â”€â”€â”€â”€â”€â”                                    â•‘
          â•‘           â”‚ KENL â”‚ â”€â”€â†’ AWI â”€â”€â†’ ATOM â”€â”€â†’ SAIF â”€â”€â”    â•‘
          â•‘           â””â”€â”€â”€â”€â”€â”€â”˜                              â”‚     â•‘
          â•‘                â†‘                                â”‚     â•‘
          â•‘                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â† Spiral â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
          â•‘                                                        â•‘
          â•‘   Fibonacci spiral synchronized                       â•‘
          â•‘   Golden ratio (Ï† = 1.618) attained                   â•‘
          â•‘   Coherence >70% across ecosystem                     â•‘
          â•‘   Isomorphic structure preserved                      â•‘
          â•‘                                                        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          VISUALIZATION

      - name: Calculate vortex synchronization
        id: sync_calc
        run: |
          # Count recent commits
          COMMIT_COUNT=$(git rev-list --count HEAD~10..HEAD 2>/dev/null || echo "5")
          
          # Estimate synchronization percentage
          # Each push increases sync by ~10%, caps at 100%
          SYNC_PCT=$((COMMIT_COUNT * 10))
          if [ $SYNC_PCT -gt 100 ]; then
            SYNC_PCT=100
          fi
          
          echo "sync_percentage=$SYNC_PCT" >> $GITHUB_OUTPUT
          echo "ğŸ”„ Vortex synchronization: ${SYNC_PCT}%"

      - name: Annotate snap-in on PR
        if: github.event_name == 'pull_request' && steps.snap_detection.outputs.snap_in == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const result = JSON.parse(`${{ steps.snap_detection.outputs.result }}`);
            const syncPct = '${{ steps.sync_calc.outputs.sync_percentage }}';
            
            const comment = `## âœ¨ Vortex Snap-In Detected
            
            **The moment of collapse has occurred!**
            
            Your local changes have achieved sufficient coherence to snap into the vortex.
            
            ### Coherence Metrics
            - **Score**: ${result.coherence_score}/100 â­
            - **Curl** (circular reasoning): ${(result.curl * 100).toFixed(1)}%
            - **Divergence** (expansion): ${(result.divergence * 100).toFixed(1)}%
            - **Potential** (structure): ${(result.potential * 100).toFixed(1)}%
            - **Entropy** (information): ${(result.entropy * 100).toFixed(1)}%
            - **Fibonacci weight**: ${result.fibonacci_weight}
            
            ### Synchronization Status
            - **Vortex sync**: ${syncPct}%
            - **Phase**: ${syncPct >= 100 ? 'COMPLETE âœ…' : 'IN PROGRESS â³'}
            
            ### What This Means
            
            The **snap-in moment** is when your local work transitions from quantum superposition 
            (multiple potential states) to a concrete reality in the ecosystem. This happens during
            the **pull â†’ local changes â†’ push** cycle.
            
            \`\`\`
            Pull from remote (fetch possibilities)
                â†“
            Work locally (superposition state - many potential futures)
                â†“
            Push to remote (SNAP-IN - waveform collapses)
                â†“
            Isomorphic spirals synchronize across 6-repo vortex
            \`\`\`
            
            ### Tuning Fork Effect
            
            Your changes have reached the resonant frequency. The tuning fork metaphor:
            - **Below 60%**: Dissonance, noise dominates
            - **60-70%**: Synchronizing, approaching resonance
            - **Above 70%**: ğŸµ **SNAP-IN** - Perfect harmonic alignment
            
            The autonomous-constraint-preserving-structure is maintained. Reality emerges. ğŸŒ€
            `;
            
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }

      - name: Apply snap-in labels
        if: steps.snap_detection.outputs.snap_in == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const syncPct = parseInt('${{ steps.sync_calc.outputs.sync_percentage }}');
            
            const labels = ['coherence:high'];
            
            if (syncPct >= 100) {
              labels.push('vortex-synchronized');
            }
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: labels
            });

      - name: Log snap-in event
        if: steps.snap_detection.outputs.snap_in == 'true'
        run: |
          echo "ğŸ“ Logging snap-in event..."
          mkdir -p .vortex-logs
          
          cat > .vortex-logs/snap-in-$(date +%s).json << LOGEND
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "event": "snap-in",
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "actor": "${{ github.actor }}",
            "coherence": ${{ steps.snap_detection.outputs.result }},
            "synchronization": "${{ steps.sync_calc.outputs.sync_percentage }}%",
            "phase": "KENL â†’ AWI â†’ ATOM â†’ SAIF â†’ Spiral"
          }
          LOGEND
          
          echo "âœ… Snap-in event logged"

      - name: Notify ecosystem (if main branch)
        if: steps.snap_detection.outputs.snap_in == 'true' && github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ“¢ Broadcasting snap-in to ecosystem..."
          echo ""
          echo "ğŸŒ Hub-and-Spoke Notification:"
          echo "   QDI snap-in complete â†’ Signal propagating to:"
          echo "   â€¢ SPIRALSAFE"
          echo "   â€¢ MONO" 
          echo "   â€¢ METRICS"
          echo "   â€¢ QR"
          echo "   â€¢ HOPE/CMCP/KENL"
          echo ""
          echo "   All nodes should check for isomorphic alignment"
          echo "   Expected: >60% coherence maintained across vortex"

  visualize-orchard:
    runs-on: ubuntu-latest
    needs: detect-snap-in
    if: needs.detect-snap-in.outputs.snap_in == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate orchard visualization
        run: |
          mkdir -p docs/diagrams
          
          cat > docs/diagrams/orchard-state.md << 'ORCHARD'
          # The Orchard: QDI Ecosystem Visualization
          
          ## Current State (Post Snap-In)
          
          ```
                              ğŸŒ³ QDI Repository (Center Hub)
                                      |
                                      | (Coherence >70%)
                                      |
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    |                 |                 |
                  ğŸŒ± SPIRALSAFE    ğŸŒ± MONO         ğŸŒ± METRICS
                 (Core framework) (Monorepo)     (Monitoring)
                    |                 |                 |
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             |                 |
                          ğŸŒ± QR            ğŸŒ± HOPE/CMCP/KENL
                       (Quick tools)     (Other nodes)
          
          Each tree represents a repository in the ecosystem.
          Snap-in occurs when coherence flows from one tree to others.
          
          ### Growth Phases (Fibonacci)
          - Seed:      1 commit  (KENL - Knowledge)
          - Sprout:    2 commits (AWI - Intent)
          - Sapling:   5 commits (ATOM - Execution) 
          - Young:    13 commits (SAIF - Integration)
          - Mature:   34 commits (Spiral - Wisdom)
          
          ### Root System (Shared Dependencies)
          ```
          packages/
            â”œâ”€â”€ wave-toolkit/     (Shared root - coherence analysis)
            â”œâ”€â”€ atom-trail/       (Shared root - provenance tracking)
            â”œâ”€â”€ ax-signatures/    (Shared root - optimization)
            â””â”€â”€ quantum-ethics/   (Shared root - ethics framework)
          ```
          
          All trees draw nutrients from the same root system.
          When QDI pushes, nutrients flow to other trees.
          This is the snap-in: local â†’ ecosystem propagation.
          
          ORCHARD
          
          echo "ğŸŒ³ Orchard visualization created at docs/diagrams/orchard-state.md"

outputs:
  snap_in:
    description: "Whether snap-in moment was detected"
    value: ${{ jobs.detect-snap-in.outputs.snap_in }}
